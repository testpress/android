name: Release Update All Institutes

on:
  push:
    branches:
      - 'fix_fast_lane'
  workflow_dispatch:

jobs:
  # Step 1: Fetch Subdomains
  fetch_subdomains:
    runs-on: ubuntu-latest
    outputs:
      subdomains: ${{ steps.fetch.outputs.subdomains }}
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Fetch subdomains
        id: fetch
        run: |
          # Simulating subdomain fetching; replace this with the actual fetching logic if needed
          echo '[ "aceachievers", "aegonlearning", "fortuneiasacademy", "igate", "metier", "phire", "wincentre", "upscprep", "legacyiasacademy", "3ritechnologies", "dentalpulseacademy", "preppias", "erudite", "teammatesacademy", "lucentias", "stansys", "scoreacademytvm", "elceducation", "logiceducation", "chaithanyaclasses", "bpscconceptwallah", "delhiias", "kpias", "clearmycourse", "clinilaunchresearch", "eea", "sureshiasacademy", "catjee", "mplus", "kakatiya", "cubitacademy", "cywerlearning", "wingsway2", "ibs", "graceias", "emfavour", "civils360ias", "civilsfront", "kshitivivan", "metagate", "heritageonline", "cuetbaba", "examclutch", "mauroentropico", "mist", "nammakpsc", "photoncsa", "pyramidiasacademy", "rcreddyiasstudycircle", "brilliant", "chemistbox", "drdilip", "ignoudost", "lalsacademy", "sadikiasacademy", "saharaias", "suyamias", "edzorblaw", "jobsecura", "edusprint", "skyyskill", "evolutioneducare", "avanigaddadsc", "bhavithaacademy", "ekamias", "amalgmpg", "chandramaniiasacademy", "guidesacademy", "margdarshanias", "apex360", "csce", "cuetverse", "edukosh", "imscochin", "join2learn", "lawxpertsmv", "meenakshiacademy", "ohf", "terzaghi", "verbalmentor", "ipmverse", "higeducampus", "wisdomacademy", "tac", "averagemedicos", "bharatexam", "btree", "careacademy", "changelearningsphere", "hareesh", "itaaeducaion", "learningocean", "qafox", "wellnessdesk", "zaitoonvirtualcampus", "gowthamtnpscclasses", "lmsdemo", "sureshbanking", "simplicrack", "margdarshanias", "nethuniga", "azbacademy", "bwcampus", "aptigoat", "madhiacademy", "neogeetanjali", "gateaerospaceacademy", "savikacademy" ]' > subdomains.json
          SUBDOMAINS=$(cat subdomains.json)
          echo "::set-output name=subdomains::$SUBDOMAINS"

      - name: Initialize success and failure lists
        run: |
          echo "SUCCESS_LIST=[]" >> $GITHUB_ENV
          echo "FAILURE_LIST=[]" >> $GITHUB_ENV

  # Step 2: Deploy App for Each Subdomain
  deploy_app:
    needs: fetch_subdomains
    runs-on: ubuntu-latest
    strategy:
      matrix:
        subdomain: ${{ fromJson(needs.fetch_subdomains.outputs.subdomains) }}
    continue-on-error: true
    env:
      GITHUB_ACCESS_KEY: ${{ secrets.GH_ACCESS_KEY }}
      GITHUB_USERNAME: ${{ secrets.GH_USERNAME }}
      API_ACCESS_KEY: ${{ secrets.API_ACCESS_KEY }}
    steps:
      - name: Validate subdomain
        if: ${{ matrix.subdomain }} != 'all'
        run: |
          curl -f https://${{ matrix.subdomain }}.testpress.in/api/v2.5/admin/android/app-config/ -H "API-access-key: $API_ACCESS_KEY"
        continue-on-error: true

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Caching Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Setup ruby and fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7
          bundler-cache: true

      - name: Cache Zoom SDK files
        id: zoom-cache
        uses: actions/cache@v3
        with:
          path: |
            ./mobilertc
            ./commonlib
          key: zoom_sdk_files

      - name: Setup Zoom SDK
        if: steps.zoom-cache.outputs.cache-hit != 'true'
        run: |
          wget https://media.testpress.in/static/android/zoom_sdk.zip
          unzip -o ./zoom_sdk.zip

      - name: Build and deploy app
        id: deploy
        run: |
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          bundle exec fastlane release_update_to subdomain:${{ matrix.subdomain }} release_option:completed
        continue-on-error: true